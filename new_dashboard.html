<!DOCTYPE html>
<html lang="en">
<head>
    <title>Health Analytics Platform</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        :root {
            /* Color System */
            --primary-50: #eff6ff;
            --primary-100: #dbeafe;
            --primary-500: #3b82f6;
            --primary-600: #2563eb;
            --primary-700: #1d4ed8;
            --primary-900: #1e3a8a;
            
            --success-50: #ecfdf5;
            --success-500: #10b981;
            --success-600: #059669;
            
            --warning-50: #fffbeb;
            --warning-500: #f59e0b;
            --warning-600: #d97706;
            
            --error-50: #fef2f2;
            --error-500: #ef4444;
            --error-600: #dc2626;
            
            --gray-50: #f9fafb;
            --gray-100: #f3f4f6;
            --gray-200: #e5e7eb;
            --gray-300: #d1d5db;
            --gray-400: #9ca3af;
            --gray-500: #6b7280;
            --gray-600: #4b5563;
            --gray-700: #374151;
            --gray-800: #1f2937;
            --gray-900: #111827;
            
            /* Spacing System (8px grid) */
            --space-1: 0.25rem;
            --space-2: 0.5rem;
            --space-3: 0.75rem;
            --space-4: 1rem;
            --space-5: 1.25rem;
            --space-6: 1.5rem;
            --space-8: 2rem;
            --space-10: 2.5rem;
            --space-12: 3rem;
            --space-16: 4rem;
            --space-20: 5rem;
            
            /* Typography */
            --font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            --font-size-xs: 0.75rem;
            --font-size-sm: 0.875rem;
            --font-size-base: 1rem;
            --font-size-lg: 1.125rem;
            --font-size-xl: 1.25rem;
            --font-size-2xl: 1.5rem;
            --font-size-3xl: 1.875rem;
            --font-size-4xl: 2.25rem;
            
            /* Shadows */
            --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
            --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
            --shadow-xl: 0 20px 25px -5px rgb(0 0 0 / 0.1), 0 8px 10px -6px rgb(0 0 0 / 0.1);
            
            /* Border Radius */
            --radius-sm: 0.25rem;
            --radius-md: 0.375rem;
            --radius-lg: 0.5rem;
            --radius-xl: 0.75rem;
            --radius-2xl: 1rem;
        }
        
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        body {
            font-family: var(--font-family);
            font-size: var(--font-size-base);
            line-height: 1.6;
            color: var(--gray-800);
            background: linear-gradient(135deg, var(--gray-50) 0%, var(--primary-50) 100%);
            min-height: 100vh;
        }
        
        /* Layout Components */
        .app-container {
            display: grid;
            grid-template-columns: 280px 1fr;
            min-height: 100vh;
        }
        
        .sidebar {
            background: white;
            border-right: 1px solid var(--gray-200);
            padding: var(--space-6);
            box-shadow: var(--shadow-sm);
        }
        
        .main-content {
            padding: var(--space-8);
            overflow-y: auto;
        }
        
        .logo {
            display: flex;
            align-items: center;
            gap: var(--space-3);
            margin-bottom: var(--space-8);
            font-size: var(--font-size-xl);
            font-weight: 700;
            color: var(--primary-600);
        }
        
        .nav-section {
            margin-bottom: var(--space-6);
        }
        
        .nav-title {
            font-size: var(--font-size-xs);
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--gray-500);
            margin-bottom: var(--space-3);
        }
        
        .nav-item {
            display: flex;
            align-items: center;
            gap: var(--space-3);
            padding: var(--space-3) var(--space-4);
            border-radius: var(--radius-lg);
            color: var(--gray-600);
            text-decoration: none;
            font-weight: 500;
            transition: all 0.2s ease;
            margin-bottom: var(--space-1);
        }
        
        .nav-item:hover, .nav-item.active {
            background: var(--primary-50);
            color: var(--primary-600);
        }
        
        .nav-item i {
            width: 20px;
            text-align: center;
        }
        
        /* Card Components */
        .card {
            background: white;
            border-radius: var(--radius-xl);
            box-shadow: var(--shadow-md);
            border: 1px solid var(--gray-100);
            overflow: hidden;
            transition: all 0.3s ease;
        }
        
        .card:hover {
            box-shadow: var(--shadow-lg);
            transform: translateY(-2px);
        }
        
        .card-header {
            padding: var(--space-6);
            border-bottom: 1px solid var(--gray-100);
            background: var(--gray-50);
        }
        
        .card-title {
            font-size: var(--font-size-lg);
            font-weight: 600;
            color: var(--gray-900);
            margin-bottom: var(--space-2);
            display: flex;
            align-items: center;
            gap: var(--space-3);
        }
        
        .card-subtitle {
            font-size: var(--font-size-sm);
            color: var(--gray-500);
        }
        
        .card-content {
            padding: var(--space-6);
        }
        
        /* Stats Cards */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: var(--space-6);
            margin-bottom: var(--space-8);
        }
        
        .stat-card {
            background: white;
            padding: var(--space-6);
            border-radius: var(--radius-xl);
            box-shadow: var(--shadow-md);
            border-left: 4px solid var(--primary-500);
            transition: all 0.3s ease;
        }
        
        .stat-card:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-xl);
        }
        
        .stat-value {
            font-size: var(--font-size-3xl);
            font-weight: 700;
            color: var(--gray-900);
            margin-bottom: var(--space-2);
        }
        
        .stat-label {
            font-size: var(--font-size-sm);
            color: var(--gray-500);
            font-weight: 500;
        }
        
        .stat-change {
            font-size: var(--font-size-xs);
            font-weight: 600;
            margin-top: var(--space-2);
        }
        
        .stat-change.positive {
            color: var(--success-600);
        }
        
        .stat-change.negative {
            color: var(--error-600);
        }
        
        /* Form Components */
        .form-group {
            margin-bottom: var(--space-5);
        }
        
        .form-label {
            display: block;
            font-size: var(--font-size-sm);
            font-weight: 500;
            color: var(--gray-700);
            margin-bottom: var(--space-2);
        }
        
        .form-input, .form-select {
            width: 100%;
            padding: var(--space-3) var(--space-4);
            border: 1px solid var(--gray-300);
            border-radius: var(--radius-lg);
            font-size: var(--font-size-base);
            transition: all 0.2s ease;
            background: white;
        }
        
        .form-input:focus, .form-select:focus {
            outline: none;
            border-color: var(--primary-500);
            box-shadow: 0 0 0 3px var(--primary-50);
        }
        
        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: var(--space-4);
            align-items: end;
        }
        
        /* Button Components */
        .btn {
            display: inline-flex;
            align-items: center;
            gap: var(--space-2);
            padding: var(--space-3) var(--space-6);
            border: none;
            border-radius: var(--radius-lg);
            font-size: var(--font-size-sm);
            font-weight: 500;
            text-decoration: none;
            cursor: pointer;
            transition: all 0.2s ease;
            white-space: nowrap;
        }
        
        .btn-primary {
            background: var(--primary-600);
            color: white;
        }
        
        .btn-primary:hover {
            background: var(--primary-700);
            transform: translateY(-1px);
            box-shadow: var(--shadow-md);
        }
        
        .btn-secondary {
            background: var(--gray-100);
            color: var(--gray-700);
        }
        
        .btn-secondary:hover {
            background: var(--gray-200);
        }
        
        .btn-success {
            background: var(--success-600);
            color: white;
        }
        
        .btn-success:hover {
            background: var(--success-700);
        }
        
        /* Upload Zone */
        .upload-zone {
            border: 2px dashed var(--gray-300);
            border-radius: var(--radius-xl);
            padding: var(--space-12);
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            background: var(--gray-50);
        }
        
        .upload-zone:hover {
            border-color: var(--primary-500);
            background: var(--primary-50);
        }
        
        .upload-zone.dragover {
            border-color: var(--primary-600);
            background: var(--primary-100);
            transform: scale(1.02);
        }
        
        .upload-icon {
            font-size: var(--font-size-4xl);
            color: var(--gray-400);
            margin-bottom: var(--space-4);
        }
        
        .upload-text {
            font-size: var(--font-size-lg);
            font-weight: 500;
            color: var(--gray-700);
            margin-bottom: var(--space-2);
        }
        
        .upload-subtext {
            font-size: var(--font-size-sm);
            color: var(--gray-500);
        }
        
        /* Table Components */
        .table-container {
            overflow-x: auto;
            border-radius: var(--radius-lg);
            border: 1px solid var(--gray-200);
        }
        
        .data-table {
            width: 100%;
            border-collapse: collapse;
            font-size: var(--font-size-sm);
        }
        
        .data-table th {
            background: var(--gray-50);
            padding: var(--space-4);
            text-align: left;
            font-weight: 600;
            color: var(--gray-700);
            border-bottom: 1px solid var(--gray-200);
        }
        
        .data-table td {
            padding: var(--space-4);
            border-bottom: 1px solid var(--gray-100);
        }
        
        .data-table tr:hover {
            background: var(--gray-50);
        }
        
        /* Prediction Cards */
        .prediction-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
            gap: var(--space-6);
        }
        
        .prediction-card {
            background: white;
            border-radius: var(--radius-xl);
            padding: var(--space-6);
            box-shadow: var(--shadow-md);
            border-left: 4px solid var(--gray-300);
            transition: all 0.3s ease;
        }
        
        .prediction-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }
        
        .prediction-card.improvement {
            border-left-color: var(--success-500);
        }
        
        .prediction-card.neutral {
            border-left-color: var(--warning-500);
        }
        
        .prediction-card.decline {
            border-left-color: var(--error-500);
        }
        
        .prediction-header {
            display: flex;
            justify-content: between;
            align-items: center;
            margin-bottom: var(--space-4);
        }
        
        .prediction-header h4 {
            font-size: var(--font-size-lg);
            font-weight: 600;
            color: var(--gray-900);
        }
        
        .time-horizon {
            font-size: var(--font-size-xs);
            font-weight: 500;
            color: var(--gray-500);
            background: var(--gray-100);
            padding: var(--space-1) var(--space-3);
            border-radius: var(--radius-md);
        }
        
        .delta-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--space-4);
        }
        
        .delta-value {
            font-size: var(--font-size-2xl);
            font-weight: 700;
            color: var(--primary-600);
        }
        
        .improvement-indicator {
            font-size: var(--font-size-sm);
            font-weight: 500;
        }
        
        .prediction-details {
            margin-bottom: var(--space-4);
        }
        
        .prediction-details p {
            margin-bottom: var(--space-2);
            font-size: var(--font-size-sm);
            color: var(--gray-600);
        }
        
        .reasoning, .recommendation {
            font-size: var(--font-size-sm);
            color: var(--gray-600);
            line-height: 1.5;
            margin-bottom: var(--space-3);
        }
        
        .recommendation {
            background: var(--primary-50);
            padding: var(--space-3);
            border-radius: var(--radius-md);
            border-left: 3px solid var(--primary-500);
        }
        
        /* Chart Containers */
        .chart-container {
            background: white;
            border-radius: var(--radius-lg);
            padding: var(--space-4);
            margin-bottom: var(--space-6);
            min-height: 400px;
        }
        
        /* Loading States */
        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: var(--space-12);
            color: var(--gray-500);
        }
        
        .spinner {
            width: 24px;
            height: 24px;
            border: 2px solid var(--gray-200);
            border-top: 2px solid var(--primary-500);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: var(--space-3);
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Responsive Design */
        @media (max-width: 1024px) {
            .app-container {
                grid-template-columns: 1fr;
            }
            
            .sidebar {
                display: none;
            }
            
            .main-content {
                padding: var(--space-4);
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            .form-row {
                grid-template-columns: 1fr;
            }
        }
        
        @media (max-width: 640px) {
            .prediction-grid {
                grid-template-columns: 1fr;
            }
            
            .card-content {
                padding: var(--space-4);
            }
        }
        
        /* Utility Classes */
        .text-center { text-align: center; }
        .text-right { text-align: right; }
        .font-medium { font-weight: 500; }
        .font-semibold { font-weight: 600; }
        .font-bold { font-weight: 700; }
        .text-sm { font-size: var(--font-size-sm); }
        .text-xs { font-size: var(--font-size-xs); }
        .text-gray-500 { color: var(--gray-500); }
        .text-gray-600 { color: var(--gray-600); }
        .text-primary { color: var(--primary-600); }
        .text-success { color: var(--success-600); }
        .text-error { color: var(--error-600); }
        .mb-4 { margin-bottom: var(--space-4); }
        .mb-6 { margin-bottom: var(--space-6); }
        .mt-4 { margin-top: var(--space-4); }
        .hidden { display: none; }
        
        /* Collapsible Sections */
        .collapsible {
            border: 1px solid var(--gray-200);
            border-radius: var(--radius-lg);
            margin-bottom: var(--space-4);
            overflow: hidden;
        }
        
        .collapsible-header {
            background: var(--gray-50);
            padding: var(--space-4);
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: 500;
            transition: background 0.2s ease;
        }
        
        .collapsible-header:hover {
            background: var(--gray-100);
        }
        
        .collapsible-content {
            padding: var(--space-6);
            display: none;
        }
        
        .collapsible.open .collapsible-content {
            display: block;
        }
        
        .collapsible-icon {
            transition: transform 0.2s ease;
        }
        
        .collapsible.open .collapsible-icon {
            transform: rotate(180deg);
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- Sidebar Navigation -->
        <aside class="sidebar">
            <div class="logo">
                <i class="fas fa-heartbeat"></i>
                <span>Health Analytics</span>
            </div>
            
            <nav>
                <div class="nav-section">
                    <div class="nav-title">Overview</div>
                    <a href="#dashboard" class="nav-item active" data-section="dashboard">
                        <i class="fas fa-chart-line"></i>
                        <span>Dashboard</span>
                    </a>
                    <a href="#biomarkers" class="nav-item" data-section="biomarkers">
                        <i class="fas fa-vial"></i>
                        <span>Biomarkers</span>
                    </a>
                </div>
                
                <div class="nav-section">
                    <div class="nav-title">Analysis</div>
                    <a href="#rdd" class="nav-item" data-section="rdd">
                        <i class="fas fa-chart-area"></i>
                        <span>RDD Analysis</span>
                    </a>
                    <a href="#timeseries" class="nav-item" data-section="timeseries">
                        <i class="fas fa-wave-square"></i>
                        <span>Time Series</span>
                    </a>
                    <a href="#predictions" class="nav-item" data-section="predictions">
                        <i class="fas fa-crystal-ball"></i>
                        <span>AI Predictions</span>
                    </a>
                </div>
                
                <div class="nav-section">
                    <div class="nav-title">Data</div>
                    <a href="#upload" class="nav-item" data-section="upload">
                        <i class="fas fa-upload"></i>
                        <span>Upload Data</span>
                    </a>
                    <a href="#supplements" class="nav-item" data-section="supplements">
                        <i class="fas fa-pills"></i>
                        <span>Supplements</span>
                    </a>
                </div>
            </nav>
        </aside>
        
        <!-- Main Content -->
        <main class="main-content">
            <!-- Dashboard Section -->
            <section id="dashboard-section" class="content-section">
                <div class="mb-6">
                    <h1 class="text-3xl font-bold text-gray-900 mb-2">Health Analytics Dashboard</h1>
                    <p class="text-gray-600">Track biomarkers, analyze supplement effects, and predict health trends</p>
                </div>
                
                <!-- Quick Stats -->
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-value" id="totalBiomarkers">-</div>
                        <div class="stat-label">Total Biomarkers</div>
                        <div class="stat-change positive" id="biomarkerChange">+2 this month</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="activeSupplements">-</div>
                        <div class="stat-label">Active Supplements</div>
                        <div class="stat-change" id="supplementChange">Current regimen</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="healthMetrics">-</div>
                        <div class="stat-label">Health Metrics</div>
                        <div class="stat-change positive" id="metricsChange">Daily tracking</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="significantEffects">-</div>
                        <div class="stat-label">Significant Effects</div>
                        <div class="stat-change" id="effectsChange">From RDD analysis</div>
                    </div>
                </div>
                
                <!-- Biomarker Trends Chart -->
                <div class="card mb-6">
                    <div class="card-header">
                        <div class="card-title">
                            <i class="fas fa-vial text-primary"></i>
                            Biomarker Trends
                        </div>
                        <div class="card-subtitle">Latest test results with reference ranges</div>
                    </div>
                    <div class="card-content">
                        <div class="form-row mb-4">
                            <div class="form-group">
                                <label class="form-label">Test Date</label>
                                <select id="biomarkerTestSelect" class="form-select" onchange="updateBiomarkerChart()">
                                    <option value="latest">Latest Test</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <button onclick="loadBiomarkerDates()" class="btn btn-secondary">
                                    <i class="fas fa-refresh"></i>
                                    Refresh Dates
                                </button>
                            </div>
                        </div>
                        <div id="biomarkerChart" class="chart-container"></div>
                    </div>
                </div>
            </section>
            
            <!-- Biomarkers Section -->
            <section id="biomarkers-section" class="content-section hidden">
                <div class="mb-6">
                    <h1 class="text-3xl font-bold text-gray-900 mb-2">Biomarker Management</h1>
                    <p class="text-gray-600">Add and track your lab test results</p>
                </div>
                
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">
                            <i class="fas fa-plus-circle text-success"></i>
                            Add Blood Test Results
                        </div>
                    </div>
                    <div class="card-content">
                        <form onsubmit="addBiomarker(event)">
                            <div class="form-row">
                                <div class="form-group">
                                    <label class="form-label">Biomarker Name</label>
                                    <input type="text" id="biomarkerName" class="form-input" placeholder="e.g., Total Cholesterol" required>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Value</label>
                                    <input type="number" id="biomarkerValue" class="form-input" placeholder="5.2" step="0.01" required>
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label class="form-label">Unit</label>
                                    <input type="text" id="biomarkerUnit" class="form-input" placeholder="mmol/L">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Test Date</label>
                                    <input type="date" id="testDate" class="form-input" required>
                                </div>
                            </div>
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-save"></i>
                                Add Biomarker
                            </button>
                        </form>
                    </div>
                </div>
            </section>
            
            <!-- RDD Analysis Section -->
            <section id="rdd-section" class="content-section hidden">
                <div class="mb-6">
                    <h1 class="text-3xl font-bold text-gray-900 mb-2">Regression Discontinuity Analysis</h1>
                    <p class="text-gray-600">Measure causal effects of supplement interventions</p>
                </div>
                
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">
                            <i class="fas fa-chart-area text-primary"></i>
                            RDD Analysis Setup
                        </div>
                    </div>
                    <div class="card-content">
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">Health Metric</label>
                                <select id="rddMetricSelect" class="form-select">
                                    <option value="">Select a metric...</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Intervention Date</label>
                                <select id="rddInterventionSelect" class="form-select">
                                    <option value="">Select intervention date...</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <button onclick="analyzeRDDWithPlots()" class="btn btn-primary">
                                    <i class="fas fa-chart-line"></i>
                                    Analyze Effects
                                </button>
                            </div>
                        </div>
                        
                        <div id="rddResults" class="mt-6"></div>
                        <div id="rddPlotChart" class="chart-container"></div>
                    </div>
                </div>
            </section>
            
            <!-- Time Series Section -->
            <section id="timeseries-section" class="content-section hidden">
                <div class="mb-6">
                    <h1 class="text-3xl font-bold text-gray-900 mb-2">Time Series Analysis</h1>
                    <p class="text-gray-600">ARIMA decomposition and forecasting</p>
                </div>
                
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">
                            <i class="fas fa-wave-square text-primary"></i>
                            Time Series Setup
                        </div>
                    </div>
                    <div class="card-content">
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">Health Metric</label>
                                <select id="timeseriesMetricSelect" class="form-select">
                                    <option value="">Select a metric...</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <button onclick="analyzeTimeSeries()" class="btn btn-primary">
                                    <i class="fas fa-chart-line"></i>
                                    Analyze Time Series
                                </button>
                            </div>
                        </div>
                        
                        <div id="timeseriesChart" class="chart-container"></div>
                        <div id="decompositionChart" class="chart-container"></div>
                    </div>
                </div>
            </section>
            
            <!-- AI Predictions Section -->
            <section id="predictions-section" class="content-section hidden">
                <div class="mb-6">
                    <h1 class="text-3xl font-bold text-gray-900 mb-2">AI-Powered Predictions</h1>
                    <p class="text-gray-600">Expected biomarker changes based on current trends</p>
                </div>
                
                <div class="card mb-6">
                    <div class="card-header">
                        <div class="card-title">
                            <i class="fas fa-filter text-primary"></i>
                            Prediction Filters
                        </div>
                    </div>
                    <div class="card-content">
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">Biomarker</label>
                                <select id="deltaBiomarkerSelect" class="form-select" onchange="updatePredictionDisplay()">
                                    <option value="">All biomarkers</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Time Horizon</label>
                                <select id="deltaMonthsSelect" class="form-select" onchange="updatePredictionDisplay()">
                                    <option value="">All timeframes</option>
                                    <option value="3">3 months</option>
                                    <option value="6">6 months</option>
                                    <option value="12">12 months</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div id="deltaPredictions" class="prediction-grid"></div>
            </section>
            
            <!-- Upload Section -->
            <section id="upload-section" class="content-section hidden">
                <div class="mb-6">
                    <h1 class="text-3xl font-bold text-gray-900 mb-2">Data Upload</h1>
                    <p class="text-gray-600">Import your health data from CSV files</p>
                </div>
                
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">
                            <i class="fas fa-upload text-primary"></i>
                            Upload Health Data
                        </div>
                        <div class="card-subtitle">Expected columns: date, metric_name, value, unit</div>
                    </div>
                    <div class="card-content">
                        <div class="upload-zone" onclick="document.getElementById('csvFile').click()">
                            <div class="upload-icon">
                                <i class="fas fa-cloud-upload-alt"></i>
                            </div>
                            <div class="upload-text">Click to upload CSV file</div>
                            <div class="upload-subtext">or drag and drop your file here</div>
                        </div>
                        <input type="file" id="csvFile" accept=".csv" style="display: none;" onchange="uploadCSV(this)">
                    </div>
                </div>
            </section>
            
            <!-- Supplements Section -->
            <section id="supplements-section" class="content-section hidden">
                <div class="mb-6">
                    <h1 class="text-3xl font-bold text-gray-900 mb-2">Supplement Management</h1>
                    <p class="text-gray-600">Track your supplement regimen and expected effects</p>
                </div>
                
                <div class="card mb-6">
                    <div class="card-header">
                        <div class="card-title">
                            <i class="fas fa-plus-circle text-success"></i>
                            Add New Supplement
                        </div>
                    </div>
                    <div class="card-content">
                        <form onsubmit="addSupplement(event)">
                            <div class="form-row">
                                <div class="form-group">
                                    <label class="form-label">Supplement Name</label>
                                    <input type="text" id="supplementName" class="form-input" placeholder="e.g., Vitamin D3" required>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Start Date</label>
                                    <input type="date" id="supplementStartDate" class="form-input" required>
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label class="form-label">Dosage</label>
                                    <input type="text" id="supplementDosage" class="form-input" placeholder="1000 IU daily">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Expected Biomarkers</label>
                                    <input type="text" id="expectedBiomarkers" class="form-input" placeholder="Vitamin D, Calcium">
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Notes</label>
                                <textarea id="supplementNotes" class="form-input" placeholder="Additional notes..." rows="3"></textarea>
                            </div>
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-save"></i>
                                Add Supplement
                            </button>
                        </form>
                    </div>
                </div>
                
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">
                            <i class="fas fa-pills text-primary"></i>
                            Current Supplements
                        </div>
                        <div class="card-subtitle">
                            <button onclick="populateSupplementBiomarkers()" class="btn btn-secondary">
                                <i class="fas fa-robot"></i>
                                Auto-populate Expected Biomarkers
                            </button>
                        </div>
                    </div>
                    <div class="card-content">
                        <div class="table-container">
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th>Name</th>
                                        <th>Start Date</th>
                                        <th>Dosage</th>
                                        <th>Expected Biomarkers</th>
                                    </tr>
                                </thead>
                                <tbody id="supplementTableBody">
                                    <tr><td colspan="4" class="text-center text-gray-500">Loading supplement data...</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </section>
        </main>
    </div>
    
    <script>
        // Global variables
        let currentBiomarkerDates = {};
        let uniqueHealthMetrics = [];
        let supplementsList = [];
        let biomarkersList = [];
        let storedPredictions = [];
        
        // Navigation functionality
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize navigation
            initializeNavigation();
            
            // Load dashboard data
            loadDashboardData();
            
            // Setup drag and drop for file upload
            setupFileUpload();
        });
        
        function initializeNavigation() {
            const navItems = document.querySelectorAll('.nav-item');
            const sections = document.querySelectorAll('.content-section');
            
            navItems.forEach(item => {
                item.addEventListener('click', (e) => {
                    e.preventDefault();
                    
                    // Remove active class from all nav items
                    navItems.forEach(nav => nav.classList.remove('active'));
                    
                    // Add active class to clicked item
                    item.classList.add('active');
                    
                    // Hide all sections
                    sections.forEach(section => section.classList.add('hidden'));
                    
                    // Show target section
                    const targetSection = item.getAttribute('data-section') + '-section';
                    const section = document.getElementById(targetSection);
                    if (section) {
                        section.classList.remove('hidden');
                    }
                });
            });
        }
        
        function setupFileUpload() {
            const uploadZone = document.querySelector('.upload-zone');
            
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                uploadZone.addEventListener(eventName, preventDefaults, false);
            });
            
            function preventDefaults(e) {
                e.preventDefault();
                e.stopPropagation();
            }
            
            ['dragenter', 'dragover'].forEach(eventName => {
                uploadZone.addEventListener(eventName, highlight, false);
            });
            
            ['dragleave', 'drop'].forEach(eventName => {
                uploadZone.addEventListener(eventName, unhighlight, false);
            });
            
            function highlight(e) {
                uploadZone.classList.add('dragover');
            }
            
            function unhighlight(e) {
                uploadZone.classList.remove('dragover');
            }
            
            uploadZone.addEventListener('drop', handleDrop, false);
            
            function handleDrop(e) {
                const dt = e.dataTransfer;
                const files = dt.files;
                
                if (files.length > 0) {
                    const fileInput = document.getElementById('csvFile');
                    fileInput.files = files;
                    uploadCSV(fileInput);
                }
            }
        }
        
        async function loadDashboardData() {
            try {
                showLoading();
                
                // Load all data in parallel
                await Promise.all([
                    loadBiomarkerDates(),
                    loadUniqueMetrics(),
                    loadSupplementsList(),
                    loadInterventionDates(),
                    loadBiomarkersList(),
                    updateBiomarkerChart(),
                    loadSupplementTable(),
                    updateDashboardStats()
                ]);
                
                hideLoading();
            } catch (error) {
                console.error('Failed to load dashboard data:', error);
                hideLoading();
            }
        }
        
        function showLoading() {
            // Add loading states to various components
            const loadingHTML = '<div class="loading"><div class="spinner"></div>Loading...</div>';
            
            const biomarkerChart = document.getElementById('biomarkerChart');
            if (biomarkerChart) biomarkerChart.innerHTML = loadingHTML;
        }
        
        function hideLoading() {
            // Remove loading states - this will be handled by individual load functions
        }
        
        async function updateDashboardStats() {
            try {
                const [biomarkers, supplements, healthMetrics] = await Promise.all([
                    fetch('/biomarkers').then(r => r.json()),
                    fetch('/supplements').then(r => r.json()),
                    fetch('/health-metrics').then(r => r.json())
                ]);
                
                // Update stat cards
                document.getElementById('totalBiomarkers').textContent = new Set(biomarkers.map(b => b.name)).size;
                document.getElementById('activeSupplements').textContent = supplements.length;
                document.getElementById('healthMetrics').textContent = healthMetrics.length;
                document.getElementById('significantEffects').textContent = '2'; // This would come from RDD analysis
                
            } catch (error) {
                console.error('Failed to update dashboard stats:', error);
            }
        }
        
        // Keep all existing JavaScript functions but update them to work with new UI
        async function loadBiomarkerDates() {
            try {
                const response = await fetch('/biomarkers/dates');
                currentBiomarkerDates = await response.json();
                
                const selector = document.getElementById('biomarkerTestSelect');
                selector.innerHTML = '<option value="latest">Latest Test</option>';
                
                const allDates = new Set();
                Object.values(currentBiomarkerDates).forEach(dates => {
                    dates.forEach(d => allDates.add(d.date));
                });
                
                Array.from(allDates).sort().reverse().forEach(date => {
                    const option = document.createElement('option');
                    option.value = date;
                    option.textContent = new Date(date).toLocaleDateString();
                    selector.appendChild(option);
                });
                
            } catch (error) {
                console.error('Failed to load biomarker dates:', error);
            }
        }
        
        async function loadUniqueMetrics() {
            try {
                const response = await fetch('/health-metrics/unique');
                uniqueHealthMetrics = await response.json();
                
                const rddSelector = document.getElementById('rddMetricSelect');
                const timeseriesSelector = document.getElementById('timeseriesMetricSelect');
                
                [rddSelector, timeseriesSelector].forEach(selector => {
                    selector.innerHTML = '<option value="">Select a metric...</option>';
                    uniqueHealthMetrics.forEach(metric => {
                        const option = document.createElement('option');
                        option.value = metric.name;
                        option.textContent = `${metric.name} (${metric.data_points} points)`;
                        selector.appendChild(option);
                    });
                });
                
            } catch (error) {
                console.error('Failed to load unique metrics:', error);
            }
        }
        
        async function loadSupplementsList() {
            try {
                const response = await fetch('/supplements');
                supplementsList = await response.json();
            } catch (error) {
                console.error('Failed to load supplements:', error);
            }
        }
        
        async function loadInterventionDates() {
            try {
                const response = await fetch('/supplements');
                const supplements = await response.json();
                
                const uniqueDates = [...new Set(supplements.map(s => s.start_date))].sort();
                
                const selector = document.getElementById('rddInterventionSelect');
                selector.innerHTML = '<option value="">Select intervention date...</option>';
                
                uniqueDates.forEach(date => {
                    const option = document.createElement('option');
                    option.value = date;
                    option.textContent = date;
                    selector.appendChild(option);
                });
                
            } catch (error) {
                console.error('Failed to load intervention dates:', error);
            }
        }
        
        async function loadBiomarkersList() {
            try {
                const response = await fetch('/biomarkers');
                biomarkersList = await response.json();
                
                const uniqueNames = [...new Set(biomarkersList.map(b => b.name))];
                const selector = document.getElementById('deltaBiomarkerSelect');
                selector.innerHTML = '<option value="">All biomarkers</option>';
                
                uniqueNames.forEach(name => {
                    const option = document.createElement('option');
                    option.value = name;
                    option.textContent = name;
                    selector.appendChild(option);
                });
                
                await loadStoredPredictions();
                
            } catch (error) {
                console.error('Failed to load biomarkers:', error);
            }
        }
        
        async function updateBiomarkerChart() {
            try {
                const response = await fetch('/biomarkers');
                const biomarkers = await response.json();
                
                if (biomarkers.length === 0) {
                    document.getElementById('biomarkerChart').innerHTML = '<div class="text-center text-gray-500 py-12">No biomarker data available</div>';
                    return;
                }
                
                const selectedDate = document.getElementById('biomarkerTestSelect').value;
                let filteredBiomarkers = biomarkers;
                
                if (selectedDate !== 'latest') {
                    filteredBiomarkers = biomarkers.filter(b => b.test_date === selectedDate);
                } else {
                    const latest = {};
                    biomarkers.forEach(item => {
                        const biomarker = item.name;
                        if (!latest[biomarker] || item.test_date > latest[biomarker].test_date) {
                            latest[biomarker] = item;
                        }
                    });
                    filteredBiomarkers = Object.values(latest);
                }
                
                const sortedBiomarkers = filteredBiomarkers.sort((a, b) => b.value - a.value);
                const names = sortedBiomarkers.map(b => b.name);
                const values = sortedBiomarkers.map(b => b.value);
                
                const trace = {
                    x: values,
                    y: names,
                    type: 'bar',
                    orientation: 'h',
                    marker: {
                        color: values,
                        colorscale: 'Viridis',
                        showscale: true,
                        colorbar: {
                            title: 'Values',
                            titlefont: { size: 14 }
                        }
                    },
                    hovertemplate: '<b>%{y}</b><br>Value: %{x}<br><extra></extra>'
                };
                
                const layout = {
                    title: {
                        text: 'Biomarker Values (Latest Results)',
                        font: { size: 18, family: 'Inter' }
                    },
                    xaxis: { 
                        title: 'Values',
                        titlefont: { size: 14 }
                    },
                    yaxis: { 
                        title: '',
                        titlefont: { size: 14 }
                    },
                    margin: { l: 150, r: 60, t: 60, b: 60 },
                    font: { family: 'Inter' },
                    plot_bgcolor: 'rgba(0,0,0,0)',
                    paper_bgcolor: 'rgba(0,0,0,0)'
                };
                
                Plotly.newPlot('biomarkerChart', [trace], layout, {responsive: true});
                
            } catch (error) {
                console.error('Failed to update biomarker chart:', error);
                document.getElementById('biomarkerChart').innerHTML = '<div class="text-center text-error py-12">Failed to load biomarker data</div>';
            }
        }
        
        async function loadSupplementTable() {
            try {
                const response = await fetch('/supplements');
                const supplements = await response.json();
                
                const tableBody = document.getElementById('supplementTableBody');
                
                if (supplements.length === 0) {
                    tableBody.innerHTML = '<tr><td colspan="4" class="text-center text-gray-500">No supplement data available</td></tr>';
                    return;
                }
                
                tableBody.innerHTML = supplements.map(supplement => `
                    <tr>
                        <td class="font-medium">${supplement.name}</td>
                        <td>${new Date(supplement.start_date).toLocaleDateString()}</td>
                        <td>${supplement.dosage || '<span class="text-gray-400">Not specified</span>'}</td>
                        <td>${supplement.expected_biomarkers || '<span class="text-gray-400">None specified</span>'}</td>
                    </tr>
                `).join('');
                
            } catch (error) {
                console.error('Failed to load supplement table:', error);
            }
        }
        
        async function loadStoredPredictions() {
            try {
                const response = await fetch('/ai/stored-predictions');
                storedPredictions = await response.json();
                
                console.log(`Loaded ${storedPredictions.length} stored predictions`);
                updatePredictionDisplay();
                
            } catch (error) {
                console.error('Failed to load stored predictions:', error);
                document.getElementById('deltaPredictions').innerHTML = '<div class="text-center text-gray-500 py-12">Predictions are being generated. Please refresh the page in a few minutes.</div>';
            }
        }
        
        function updatePredictionDisplay() {
            const selectedBiomarker = document.getElementById('deltaBiomarkerSelect').value;
            const selectedMonths = document.getElementById('deltaMonthsSelect').value;
            
            let filteredPredictions = storedPredictions;
            
            if (selectedBiomarker) {
                filteredPredictions = filteredPredictions.filter(p => p.biomarker_name === selectedBiomarker);
            }
            
            if (selectedMonths) {
                filteredPredictions = filteredPredictions.filter(p => p.months_ahead == selectedMonths);
            }
            
            displayPredictions(filteredPredictions);
        }
        
        function displayPredictions(predictions) {
            const container = document.getElementById('deltaPredictions');
            
            if (predictions.length === 0) {
                container.innerHTML = '<div class="text-center text-gray-500 py-12">No predictions available for the selected filters.</div>';
                return;
            }
            
            let html = '';
            predictions.forEach(prediction => {
                html += createPredictionCardHTML(prediction);
            });
            
            container.innerHTML = html;
        }
        
        function createPredictionCardHTML(prediction) {
            const isImprovement = prediction.is_improvement;
            const delta = prediction.predicted_delta;
            const cardClass = isImprovement ? 'improvement' : (Math.abs(delta) < 0.1 ? 'neutral' : 'decline');
            
            const deltaText = delta > 0 ? `+${delta}` : `${delta}`;
            const improvementIcon = isImprovement ? '' : '';
            const improvementText = isImprovement ? 'Expected Improvement' : 'Monitor Closely';
            
            return `
                <div class="prediction-card ${cardClass}">
                    <div class="prediction-header">
                        <h4>${prediction.biomarker_name}</h4>
                        <span class="time-horizon">${prediction.months_ahead} months</span>
                    </div>
                    <div class="delta-info">
                        <span class="delta-value">${deltaText}</span>
                        <span class="improvement-indicator">${improvementIcon} ${improvementText}</span>
                    </div>
                    <div class="prediction-details">
                        <p><strong>Current:</strong> ${prediction.current_value}</p>
                        <p><strong>Predicted:</strong> ${prediction.predicted_value}</p>
                        <p><strong>Confidence:</strong> ${Math.round(prediction.confidence * 100)}%</p>
                        <p><strong>Method:</strong> ${prediction.analysis_method}</p>
                    </div>
                    <div class="reasoning">
                        <p>${prediction.reasoning}</p>
                    </div>
                    <div class="recommendation">
                        <p><strong>Recommendation:</strong> ${prediction.recommendation}</p>
                    </div>
                </div>
            `;
        }
        
        // Keep all existing functions but update error handling and UI feedback
        async function uploadCSV(input) {
            const file = input.files[0];
            if (!file) return;
            
            const formData = new FormData();
            formData.append('file', file);
            
            try {
                // Show loading state
                const uploadZone = document.querySelector('.upload-zone');
                const originalHTML = uploadZone.innerHTML;
                uploadZone.innerHTML = '<div class="loading"><div class="spinner"></div>Uploading...</div>';
                
                const response = await fetch('/upload-csv', {
                    method: 'POST',
                    body: formData
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    // Show success message
                    uploadZone.innerHTML = '<div class="text-center text-success py-8"><i class="fas fa-check-circle text-4xl mb-4"></i><div class="text-lg font-medium">Upload Successful!</div><div class="text-sm text-gray-600">' + result.message + '</div></div>';
                    
                    // Refresh dashboard data
                    setTimeout(() => {
                        uploadZone.innerHTML = originalHTML;
                        loadDashboardData();
                    }, 3000);
                } else {
                    throw new Error(result.detail || 'Upload failed');
                }
            } catch (error) {
                // Show error message
                const uploadZone = document.querySelector('.upload-zone');
                uploadZone.innerHTML = '<div class="text-center text-error py-8"><i class="fas fa-exclamation-triangle text-4xl mb-4"></i><div class="text-lg font-medium">Upload Failed</div><div class="text-sm text-gray-600">' + error.message + '</div></div>';
                
                setTimeout(() => {
                    location.reload(); // Reset the upload zone
                }, 3000);
            }
        }
        
        async function addBiomarker(event) {
            event.preventDefault();
            
            const biomarker = {
                name: document.getElementById('biomarkerName').value,
                value: parseFloat(document.getElementById('biomarkerValue').value),
                unit: document.getElementById('biomarkerUnit').value,
                test_date: document.getElementById('testDate').value
            };
            
            try {
                const response = await fetch('/biomarkers', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(biomarker)
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    // Show success feedback
                    showNotification('Biomarker added successfully!', 'success');
                    event.target.reset();
                    loadDashboardData();
                } else {
                    throw new Error(result.detail || 'Failed to add biomarker');
                }
            } catch (error) {
                showNotification('Failed to add biomarker: ' + error.message, 'error');
            }
        }
        
        async function addSupplement(event) {
            event.preventDefault();
            
            const supplement = {
                name: document.getElementById('supplementName').value,
                start_date: document.getElementById('supplementStartDate').value,
                dosage: document.getElementById('supplementDosage').value,
                expected_biomarkers: document.getElementById('expectedBiomarkers').value,
                notes: document.getElementById('supplementNotes').value
            };
            
            try {
                const response = await fetch('/supplements', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(supplement)
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    showNotification('Supplement added successfully!', 'success');
                    event.target.reset();
                    loadDashboardData();
                } else {
                    throw new Error(result.detail || 'Failed to add supplement');
                }
            } catch (error) {
                showNotification('Failed to add supplement: ' + error.message, 'error');
            }
        }
        
        function showNotification(message, type = 'info') {
            // Create notification element
            const notification = document.createElement('div');
            notification.className = `notification notification-${type}`;
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 16px 24px;
                border-radius: 8px;
                color: white;
                font-weight: 500;
                z-index: 1000;
                transform: translateX(100%);
                transition: transform 0.3s ease;
            `;
            
            // Set background color based on type
            const colors = {
                success: 'var(--success-600)',
                error: 'var(--error-600)',
                info: 'var(--primary-600)',
                warning: 'var(--warning-600)'
            };
            notification.style.backgroundColor = colors[type] || colors.info;
            
            notification.textContent = message;
            document.body.appendChild(notification);
            
            // Animate in
            setTimeout(() => {
                notification.style.transform = 'translateX(0)';
            }, 100);
            
            // Remove after 5 seconds
            setTimeout(() => {
                notification.style.transform = 'translateX(100%)';
                setTimeout(() => {
                    document.body.removeChild(notification);
                }, 300);
            }, 5000);
        }
        
        // Keep all other existing functions (RDD analysis, time series, etc.) 
        // but update them to use the new notification system and loading states
        
        async function populateSupplementBiomarkers() {
            try {
                const button = event.target;
                const originalText = button.innerHTML;
                button.disabled = true;
                button.innerHTML = '<div class="spinner" style="width: 16px; height: 16px; margin-right: 8px;"></div>Populating...';
                
                const response = await fetch('/populate-supplement-biomarkers', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'}
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    showNotification(result.message || 'Successfully populated expected biomarkers!', 'success');
                    await loadSupplementTable();
                } else {
                    throw new Error(result.error || result.detail || 'Failed to populate biomarkers');
                }
                
            } catch (error) {
                console.error('Failed to populate supplement biomarkers:', error);
                showNotification('Failed to populate biomarkers: ' + error.message, 'error');
            } finally {
                const button = document.querySelector('button[onclick="populateSupplementBiomarkers()"]');
                if (button) {
                    button.disabled = false;
                    button.innerHTML = '<i class="fas fa-robot"></i> Auto-populate Expected Biomarkers';
                }
            }
        }
        
        // Add the remaining functions (RDD analysis, time series, etc.) with updated styling
        async function analyzeRDDWithPlots() {
            const metric = document.getElementById('rddMetricSelect').value;
            const interventionDate = document.getElementById('rddInterventionSelect').value;
            
            if (!metric || !interventionDate) {
                showNotification('Please select both a metric and an intervention date', 'warning');
                return;
            }
            
            try {
                // Show loading state
                document.getElementById('rddResults').innerHTML = '<div class="loading"><div class="spinner"></div>Analyzing...</div>';
                document.getElementById('rddPlotChart').innerHTML = '<div class="loading"><div class="spinner"></div>Generating plots...</div>';
                
                const response = await fetch(`/rdd/plot/${encodeURIComponent(metric)}/${encodeURIComponent(interventionDate)}`);
                const result = await response.json();
                
                if (result.error) {
                    document.getElementById('rddResults').innerHTML = `<div class="text-center text-error py-8">${result.error}</div>`;
                    return;
                }
                
                displayRDDResults(result.effect_analysis, metric);
                createRDDPlot(result.plot_data);
                
            } catch (error) {
                console.error('RDD analysis failed:', error);
                document.getElementById('rddResults').innerHTML = '<div class="text-center text-error py-8">Analysis failed. Please try again.</div>';
                showNotification('RDD analysis failed: ' + error.message, 'error');
            }
        }
        
        function displayRDDResults(result, metric) {
            let html = `<div class="card"><div class="card-header"><div class="card-title"><i class="fas fa-chart-line text-primary"></i>Analysis Results for ${metric.replace('_', ' ').toUpperCase()}</div></div><div class="card-content">`;
            
            if (result.treatment_effect !== undefined) {
                const effectColor = result.statistically_significant ? 'var(--success-600)' : 'var(--gray-500)';
                const effectText = result.statistically_significant ? 'Statistically Significant' : 'Not Significant';
                const effectIcon = result.statistically_significant ? 'fas fa-check-circle' : 'fas fa-info-circle';
                
                html += `
                    <div class="stat-card" style="border-left-color: ${effectColor};">
                        <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 16px;">
                            <i class="${effectIcon}" style="color: ${effectColor}; font-size: 24px;"></i>
                            <h3 style="color: ${effectColor}; margin: 0;">${effectText}</h3>
                        </div>
                        <div class="form-row" style="margin-bottom: 0;">
                            <div>
                                <div class="stat-value" style="font-size: 1.5rem;">${result.treatment_effect.toFixed(3)}</div>
                                <div class="stat-label">Treatment Effect</div>
                            </div>
                            <div>
                                <div class="stat-value" style="font-size: 1.5rem;">${result.treatment_p_value.toFixed(4)}</div>
                                <div class="stat-label">P-value</div>
                            </div>
                            <div>
                                <div class="stat-value" style="font-size: 1.5rem;">${result.bandwidth_days}</div>
                                <div class="stat-label">Bandwidth (days)</div>
                            </div>
                            <div>
                                <div class="stat-value" style="font-size: 1.5rem;">${result.n_observations}</div>
                                <div class="stat-label">Data Points</div>
                            </div>
                        </div>
                    </div>
                `;
            } else {
                html += '<div class="text-center text-gray-500 py-8">No effect could be estimated. Try adjusting the bandwidth or check if you have enough data points.</div>';
            }
            
            html += '</div></div>';
            document.getElementById('rddResults').innerHTML = html;
        }
        
        function createRDDPlot(plotData) {
            if (plotData.error) {
                document.getElementById('rddPlotChart').innerHTML = `<div class="text-center text-error py-8">${plotData.error}</div>`;
                return;
            }
            
            const traces = [];
            
            if (plotData.scatter) {
                const beforeX = plotData.scatter.x_all.filter((x, i) => plotData.scatter.treatment[i] === 0);
                const beforeY = plotData.scatter.y_all.filter((x, i) => plotData.scatter.treatment[i] === 0);
                
                traces.push({
                    x: beforeX,
                    y: beforeY,
                    mode: 'markers',
                    type: 'scatter',
                    name: 'Before Treatment',
                    marker: { color: 'var(--primary-500)', size: 8, opacity: 0.7 }
                });
                
                const afterX = plotData.scatter.x_all.filter((x, i) => plotData.scatter.treatment[i] === 1);
                const afterY = plotData.scatter.y_all.filter((x, i) => plotData.scatter.treatment[i] === 1);
                
                traces.push({
                    x: afterX,
                    y: afterY,
                    mode: 'markers',
                    type: 'scatter',
                    name: 'After Treatment',
                    marker: { color: 'var(--success-500)', size: 8, opacity: 0.7 }
                });
            }
            
            if (plotData.before_line) {
                traces.push({
                    x: plotData.before_line.x,
                    y: plotData.before_line.y,
                    mode: 'lines',
                    type: 'scatter',
                    name: 'Before Trend',
                    line: { color: 'var(--primary-600)', width: 3 }
                });
            }
            
            if (plotData.after_line) {
                traces.push({
                    x: plotData.after_line.x,
                    y: plotData.after_line.y,
                    mode: 'lines',
                    type: 'scatter',
                    name: 'After Trend',
                    line: { color: 'var(--success-600)', width: 3 }
                });
            }
            
            traces.push({
                x: [plotData.cutoff, plotData.cutoff],
                y: [Math.min(...plotData.scatter.y_all) * 0.9, Math.max(...plotData.scatter.y_all) * 1.1],
                mode: 'lines',
                type: 'scatter',
                name: 'Treatment Start',
                line: { color: 'var(--gray-600)', width: 2, dash: 'dash' }
            });
            
            const layout = {
                title: {
                    text: `Regression Discontinuity Analysis<br><sub>Treatment Effect: ${plotData.treatment_effect.toFixed(3)}</sub>`,
                    font: { size: 18, family: 'Inter' }
                },
                xaxis: { 
                    title: 'Days Relative to Treatment Start',
                    titlefont: { size: 14 }
                },
                yaxis: { 
                    title: 'Metric Value',
                    titlefont: { size: 14 }
                },
                font: { family: 'Inter' },
                plot_bgcolor: 'rgba(0,0,0,0)',
                paper_bgcolor: 'rgba(0,0,0,0)'
            };
            
            Plotly.newPlot('rddPlotChart', traces, layout, {responsive: true});
        }
        
        async function analyzeTimeSeries() {
            const metric = document.getElementById('timeseriesMetricSelect').value;
            
            if (!metric) {
                showNotification('Please select a metric', 'warning');
                return;
            }
            
            try {
                document.getElementById('timeseriesChart').innerHTML = '<div class="loading"><div class="spinner"></div>Analyzing time series...</div>';
                document.getElementById('decompositionChart').innerHTML = '<div class="loading"><div class="spinner"></div>Generating decomposition...</div>';
                
                const response = await fetch(`/metrics/decompose/${encodeURIComponent(metric)}`);
                const result = await response.json();
                
                if (result.error) {
                    document.getElementById('timeseriesChart').innerHTML = `<div class="text-center text-error py-8">${result.error}</div>`;
                    return;
                }
                
                createTimeSeriesPlot(result);
                
                if (result.decomposition && !result.decomposition.error) {
                    createDecompositionPlot(result);
                } else {
                    document.getElementById('decompositionChart').innerHTML = '<div class="text-center text-gray-500 py-8">Decomposition not available - need more data points</div>';
                }
                
            } catch (error) {
                console.error('Time series analysis failed:', error);
                document.getElementById('timeseriesChart').innerHTML = '<div class="text-center text-error py-8">Analysis failed. Please try again.</div>';
                showNotification('Time series analysis failed: ' + error.message, 'error');
            }
        }
        
        function createTimeSeriesPlot(data) {
            const traces = [];
            
            traces.push({
                x: data.original.dates,
                y: data.original.values,
                type: 'bar',
                name: 'Original Data',
                marker: { color: 'var(--primary-500)' }
            });
            
            if (data.forecast) {
                traces.push({
                    x: data.forecast.dates,
                    y: data.forecast.predicted,
                    mode: 'lines',
                    type: 'scatter',
                    name: 'Forecast',
                    line: { color: 'var(--success-500)', dash: 'dash', width: 3 }
                });
                
                if (data.forecast.lower_ci) {
                    traces.push({
                        x: data.forecast.dates.concat(data.forecast.dates.slice().reverse()),
                        y: data.forecast.lower_ci.concat(data.forecast.upper_ci.slice().reverse()),
                        fill: 'toself',
                        fillcolor: 'rgba(16, 185, 129, 0.2)',
                        line: { color: 'transparent' },
                        name: 'Forecast CI',
                        showlegend: false
                    });
                }
            }
            
            const layout = {
                title: {
                    text: `${data.metric} Time Series with Forecast`,
                    font: { size: 18, family: 'Inter' }
                },
                xaxis: { 
                    title: 'Date',
                    titlefont: { size: 14 }
                },
                yaxis: { 
                    title: 'Value',
                    titlefont: { size: 14 }
                },
                font: { family: 'Inter' },
                plot_bgcolor: 'rgba(0,0,0,0)',
                paper_bgcolor: 'rgba(0,0,0,0)'
            };
            
            Plotly.newPlot('timeseriesChart', traces, layout, {responsive: true});
        }
        
        function createDecompositionPlot(data) {
            if (!data.decomposition || data.decomposition.error) return;
            
            const decomp = data.decomposition;
            const traces = [];
            
            traces.push({
                x: decomp.trend.dates,
                y: decomp.trend.values,
                mode: 'lines',
                type: 'scatter',
                name: 'Trend',
                yaxis: 'y1',
                line: { color: 'var(--primary-600)', width: 2 }
            });
            
            traces.push({
                x: decomp.seasonal.dates,
                y: decomp.seasonal.values,
                mode: 'lines',
                type: 'scatter',
                name: 'Seasonal',
                yaxis: 'y2',
                line: { color: 'var(--success-600)', width: 2 }
            });
            
            traces.push({
                x: decomp.residual.dates,
                y: decomp.residual.values,
                mode: 'lines',
                type: 'scatter',
                name: 'Residual',
                yaxis: 'y3',
                line: { color: 'var(--warning-600)', width: 2 }
            });
            
            const layout = {
                title: {
                    text: 'Time Series Decomposition (ARIMA)',
                    font: { size: 18, family: 'Inter' }
                },
                grid: {rows: 3, columns: 1, subplots:[['xy'],['xy2'],['xy3']]},
                yaxis: {title: 'Trend'},
                yaxis2: {title: 'Seasonal'},
                yaxis3: {title: 'Residual'},
                font: { family: 'Inter' },
                plot_bgcolor: 'rgba(0,0,0,0)',
                paper_bgcolor: 'rgba(0,0,0,0)',
                height: 600
            };
            
            Plotly.newPlot('decompositionChart', traces, layout, {responsive: true});
        }
    </script>
</body>
</html>