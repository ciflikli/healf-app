<!DOCTYPE html>
<html>
<head>
    <title>Health Data Analytics</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, sans-serif; margin: 0; padding: 20px; background: #f8f9fa; }
        .container { max-width: 1200px; margin: 0 auto; }
        .header { background: white; padding: 20px; border-radius: 8px; margin-bottom: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .card { background: white; padding: 20px; border-radius: 8px; margin-bottom: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .upload-zone { border: 2px dashed #ddd; padding: 20px; text-align: center; border-radius: 8px; cursor: pointer; }
        .upload-zone:hover { border-color: #007bff; background: #f8f9ff; }
        .btn { background: #007bff; color: white; border: none; padding: 12px 24px; border-radius: 6px; cursor: pointer; font-size: 14px; }
        .btn:hover { background: #0056b3; }
        .btn-secondary { background: #6c757d; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; font-size: 12px; }
        .btn-secondary:hover { background: #545b62; }
        
        /* Collapsible sections */
        details { margin-bottom: 15px; }
        summary { font-weight: bold; cursor: pointer; padding: 10px; background: #f8f9fa; border-radius: 4px; margin-bottom: 10px; }
        summary:hover { background: #e9ecef; }
        
        /* Table styles */
        .data-table { width: 100%; border-collapse: collapse; margin: 15px 0; }
        .data-table th, .data-table td { padding: 8px 12px; text-align: left; border-bottom: 1px solid #ddd; }
        .data-table th { background: #f8f9fa; font-weight: 600; }
        .data-table tr:hover { background: #f8f9ff; }
        
        /* Form styles */
        .form-input { width: 100%; padding: 8px; margin: 5px 0; border: 1px solid #ddd; border-radius: 4px; }
        .form-row { display: flex; gap: 10px; align-items: center; margin: 10px 0; }
        .form-row label { min-width: 120px; font-weight: 500; }
        .form-row select, .form-row input { flex: 1; }
        
        /* Prediction cards */
        .prediction-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 15px; }
        .prediction-card { border: 1px solid #ddd; border-radius: 8px; padding: 15px; }
        .prediction-improvement { border-left: 4px solid #28a745; }
        .prediction-neutral { border-left: 4px solid #ffc107; }
        .prediction-decline { border-left: 4px solid #dc3545; }
        .prediction-value { font-size: 1.2em; font-weight: bold; color: #007bff; }
        .prediction-delta { font-size: 0.9em; margin: 5px 0; }
        .prediction-reasoning { font-size: 0.85em; color: #666; margin-top: 10px; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üß¨ Health Data Analytics</h1>
            <p>Track biomarkers, analyze supplement effects, and predict health trends</p>
        </div>
        
        <!-- Collapsible Data Upload Section -->
        <div class="card">
            <h3>üìä Data Upload</h3>
            
            <details>
                <summary>üìÅ Upload Health Data CSV</summary>
                <div class="upload-zone" onclick="document.getElementById('csvFile').click()">
                    <div>Click to upload CSV file</div>
                    <small>Expected columns: date, metric_name, value, unit</small>
                </div>
                <input type="file" id="csvFile" accept=".csv" style="display: none;" onchange="uploadCSV(this)">
            </details>
            
            <details>
                <summary>ü©∏ Add Blood Test Results</summary>
                <form onsubmit="addBiomarker(event)">
                    <input type="text" id="biomarkerName" placeholder="Biomarker name" required class="form-input">
                    <input type="number" id="biomarkerValue" placeholder="Value" step="0.01" required class="form-input">
                    <input type="text" id="biomarkerUnit" placeholder="Unit (e.g., mg/dL)" class="form-input">
                    <input type="date" id="testDate" required class="form-input">
                    <button type="submit" class="btn" style="width: 100%; margin-top: 10px;">Add Biomarker</button>
                </form>
            </details>
            
            <details>
                <summary>üíä Track Supplements</summary>
                <form onsubmit="addSupplement(event)">
                    <input type="text" id="supplementName" placeholder="Supplement name" required class="form-input">
                    <input type="date" id="supplementStartDate" required class="form-input">
                    <input type="text" id="supplementDosage" placeholder="Dosage (e.g., 500mg daily)" class="form-input">
                    <input type="text" id="expectedBiomarkers" placeholder="Expected biomarkers (optional)" class="form-input">
                    <textarea id="supplementNotes" placeholder="Notes (optional)" class="form-input" style="height: 60px; resize: vertical;"></textarea>
                    <button type="submit" class="btn" style="width: 100%; margin-top: 10px;">Add Supplement</button>
                </form>
            </details>
        </div>
        
        <!-- 1. Biomarker Trends (First Section with Viridis Colors) -->
        <div class="card">
            <h3>üß¨ Biomarker Trends</h3>
            <div class="form-row">
                <label>Test Date:</label>
                <select id="biomarkerTestSelect" onchange="updateBiomarkerChart()">
                    <option value="latest">Latest Test</option>
                </select>
                <button onclick="loadBiomarkerDates()" class="btn-secondary">Refresh Dates</button>
            </div>
            <div id="biomarkerChart" style="height: 400px;"></div>
        </div>
        
        <!-- 2. Supplement Data (Table View) -->
        <div class="card">
            <h3>üíä Supplement Data</h3>
            <div class="form-row">
                <button onclick="populateSupplementBiomarkers()" class="btn-secondary">ü§ñ Auto-populate Expected Biomarkers</button>
                <small style="color: #666; margin-left: 15px;">Uses AI to determine which biomarkers each supplement should affect</small>
            </div>
            <div id="supplementTable">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Start Date</th>
                            <th>Dosage</th>
                            <th>Expected Biomarkers</th>
                        </tr>
                    </thead>
                    <tbody id="supplementTableBody">
                        <tr><td colspan="4">Loading supplement data...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
        
        <!-- 3. Regression Discontinuity Analysis (Enhanced with Slopes) -->
        <div class="card">
            <h3>üìà Regression Discontinuity Analysis</h3>
            <div class="form-row">
                <label>Metric:</label>
                <select id="rddMetricSelect">
                    <option value="">Select a metric...</option>
                </select>
                <label>Intervention:</label>
                <select id="rddInterventionSelect">
                    <option value="">Select intervention date...</option>
                </select>
                <button onclick="analyzeRDDWithPlots()" class="btn">Analyze with Plots</button>
            </div>
            <div id="rddResults"></div>
            <div id="rddPlotChart" style="height: 400px;"></div>
        </div>
        
        <!-- 4. Health Metrics Time Series (ARIMA Decomposition) -->
        <div class="card">
            <h3>üìä Health Metrics Time Series Analysis</h3>
            <div class="form-row">
                <label>Metric:</label>
                <select id="timeseriesMetricSelect">
                    <option value="">Select a metric...</option>
                </select>
                <button onclick="analyzeTimeSeries()" class="btn">Analyze Time Series</button>
            </div>
            <div id="timeseriesChart" style="height: 500px;"></div>
            <div id="decompositionChart" style="height: 600px;"></div>
        </div>
        
        <!-- 5. AI-Powered Biomarker Delta Predictions -->
        <div class="card">
            <h3>üîÆ Expected Biomarker Changes (Next Blood Test)</h3>
            <div class="form-row">
                <label>Biomarker:</label>
                <select id="deltaBiomarkerSelect">
                    <option value="">Select biomarker...</option>
                </select>
                <label>Months Ahead:</label>
                <select id="deltaMonthsSelect">
                    <option value="3">3 months</option>
                    <option value="6" selected>6 months</option>
                    <option value="12">12 months</option>
                </select>
                <button onclick="generateBiomarkerDeltas()" class="btn">Generate Predictions</button>
            </div>
            <div id="deltaPredictions" class="prediction-grid"></div>
        </div>
    </div>
    
    <script>
        // Global variables
        let currentBiomarkerDates = {};
        let uniqueHealthMetrics = [];
        let supplementsList = [];
        let biomarkersList = [];
        
        // Load dashboard data on page load
        document.addEventListener('DOMContentLoaded', function() {
            loadDashboardData();
        });
        
        async function loadDashboardData() {
            try {
                // Load biomarker dates for selector
                await loadBiomarkerDates();
                
                // Load unique health metrics for dropdowns
                await loadUniqueMetrics();
                
                // Load supplements for dropdown
                await loadSupplementsList();
                
                // Load intervention dates for RDD dropdown
                await loadInterventionDates();
                
                // Load biomarkers for delta predictions
                await loadBiomarkersList();
                
                // Load initial biomarker chart with viridis colors
                await updateBiomarkerChart();
                
                // Load supplement table data
                await loadSupplementTable();
                
            } catch (error) {
                console.error('Failed to load dashboard data:', error);
            }
        }
        
        async function loadBiomarkerDates() {
            try {
                const response = await fetch('/biomarkers/dates');
                currentBiomarkerDates = await response.json();
                
                // Update date selector
                const selector = document.getElementById('biomarkerTestSelect');
                selector.innerHTML = '<option value="latest">Latest Test</option>';
                
                // Add unique dates across all biomarkers
                const allDates = new Set();
                Object.values(currentBiomarkerDates).forEach(dates => {
                    dates.forEach(d => allDates.add(d.date));
                });
                
                Array.from(allDates).sort().reverse().forEach(date => {
                    const option = document.createElement('option');
                    option.value = date;
                    option.textContent = new Date(date).toLocaleDateString();
                    selector.appendChild(option);
                });
                
            } catch (error) {
                console.error('Failed to load biomarker dates:', error);
            }
        }
        
        async function loadUniqueMetrics() {
            try {
                const response = await fetch('/health-metrics/unique');
                uniqueHealthMetrics = await response.json();
                
                // Populate metric selectors
                const rddSelector = document.getElementById('rddMetricSelect');
                const timeseriesSelector = document.getElementById('timeseriesMetricSelect');
                
                [rddSelector, timeseriesSelector].forEach(selector => {
                    selector.innerHTML = '<option value="">Select a metric...</option>';
                    uniqueHealthMetrics.forEach(metric => {
                        const option = document.createElement('option');
                        option.value = metric.name;
                        option.textContent = `${metric.name} (${metric.data_points} points)`;
                        selector.appendChild(option);
                    });
                });
                
            } catch (error) {
                console.error('Failed to load unique metrics:', error);
            }
        }
        
        async function loadSupplementsList() {
            try {
                const response = await fetch('/supplements');
                supplementsList = await response.json();
                
                // Keep existing supplement selector population for other uses
                // (RDD now uses intervention dates populated separately)
                    const option = document.createElement('option');
                    option.value = supplement.name;
                    option.textContent = `${supplement.name} (${supplement.start_date})`;
                    selector.appendChild(option);
                });
                
            } catch (error) {
                console.error('Failed to load supplements:', error);
            }
        }
        
        async function loadInterventionDates() {
            try {
                const response = await fetch('/supplements');
                const supplements = await response.json();
                
                // Get distinct start dates from supplements
                const uniqueDates = [...new Set(supplements.map(s => s.start_date))].sort();
                
                // Populate intervention selector for RDD
                const selector = document.getElementById('rddInterventionSelect');
                selector.innerHTML = '<option value="">Select intervention date...</option>';
                
                uniqueDates.forEach(date => {
                    const option = document.createElement('option');
                    option.value = date;
                    option.textContent = date;
                    selector.appendChild(option);
                });
                
            } catch (error) {
                console.error('Failed to load intervention dates:', error);
            }
        }
        
        async function loadBiomarkersList() {
            try {
                const response = await fetch('/biomarkers');
                biomarkersList = await response.json();
                
                // Get unique biomarker names for delta prediction selector
                const uniqueNames = [...new Set(biomarkersList.map(b => b.name))];
                const selector = document.getElementById('deltaBiomarkerSelect');
                selector.innerHTML = '<option value="">Select biomarker...</option>';
                
                uniqueNames.forEach(name => {
                    const option = document.createElement('option');
                    option.value = name;
                    option.textContent = name;
                    selector.appendChild(option);
                });
                
            } catch (error) {
                console.error('Failed to load biomarkers:', error);
            }
        }
        
        async function updateBiomarkerChart() {
            try {
                const response = await fetch('/biomarkers');
                const biomarkers = await response.json();
                
                if (biomarkers.length === 0) return;
                
                // Get selected test date
                const selectedDate = document.getElementById('biomarkerTestSelect').value;
                let filteredBiomarkers = biomarkers;
                
                if (selectedDate !== 'latest') {
                    filteredBiomarkers = biomarkers.filter(b => b.test_date === selectedDate);
                } else {
                    // Get latest value for each biomarker
                    const latest = {};
                    biomarkers.forEach(item => {
                        const biomarker = item.name;
                        if (!latest[biomarker] || item.test_date > latest[biomarker].test_date) {
                            latest[biomarker] = item;
                        }
                    });
                    filteredBiomarkers = Object.values(latest);
                }
                
                // Sort biomarkers by value for easier reading
                const sortedBiomarkers = filteredBiomarkers.sort((a, b) => b.value - a.value);
                const names = sortedBiomarkers.map(b => b.name);
                const values = sortedBiomarkers.map(b => b.value);
                
                // Use viridis colorscale with horizontal bars
                const trace = {
                    x: values,  // Values on x-axis (horizontal)
                    y: names,   // Names on y-axis
                    type: 'bar',
                    orientation: 'h',  // Horizontal bars
                    marker: {
                        color: values,
                        colorscale: 'Viridis',
                        showscale: true,
                        colorbar: {
                            title: 'Biomarker Values'
                        }
                    },
                    hovertemplate: '<b>%{y}</b><br>Value: %{x}<br><extra></extra>'
                };
                
                const layout = {
                    title: 'Biomarker Values (Sorted by Value, Viridis Color Scale)',
                    xaxis: { title: 'Values' },
                    yaxis: { title: 'Biomarkers' },
                    margin: { l: 150, r: 60, t: 60, b: 60 },  // More left margin for biomarker names
                    template: 'plotly_white'
                };
                
                Plotly.newPlot('biomarkerChart', [trace], layout);
                
            } catch (error) {
                console.error('Failed to update biomarker chart:', error);
            }
        }
        
        async function loadSupplementTable() {
            try {
                const response = await fetch('/supplements');
                const supplements = await response.json();
                
                const tableBody = document.getElementById('supplementTableBody');
                
                if (supplements.length === 0) {
                    tableBody.innerHTML = '<tr><td colspan="4" style="text-align: center; color: #666;">No supplement data available</td></tr>';
                    return;
                }
                
                tableBody.innerHTML = supplements.map(supplement => `
                    <tr>
                        <td><strong>${supplement.name}</strong></td>
                        <td>${new Date(supplement.start_date).toLocaleDateString()}</td>
                        <td>${supplement.dosage || 'Not specified'}</td>
                        <td>${supplement.expected_biomarkers || 'None specified'}</td>
                    </tr>
                `).join('');
                
            } catch (error) {
                console.error('Failed to load supplement table:', error);
            }
        }
        
        async function populateSupplementBiomarkers() {
            try {
                const button = event.target;
                button.disabled = true;
                button.textContent = 'üîÑ Populating...';
                
                const response = await fetch('/populate-supplement-biomarkers', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'}
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    alert(result.message || 'Successfully populated expected biomarkers!');
                    // Reload the supplement table to show updated data
                    await loadSupplementTable();
                } else {
                    alert('Error: ' + (result.error || result.detail || 'Failed to populate biomarkers'));
                }
                
            } catch (error) {
                console.error('Failed to populate supplement biomarkers:', error);
                alert('Failed to populate biomarkers: ' + error.message);
            } finally {
                // Reset button
                const button = document.querySelector('button[onclick="populateSupplementBiomarkers()"]');
                if (button) {
                    button.disabled = false;
                    button.textContent = 'ü§ñ Auto-populate Expected Biomarkers';
                }
            }
        }
        
        async function analyzeRDDWithPlots() {
            const metric = document.getElementById('rddMetricSelect').value;
            const interventionDate = document.getElementById('rddInterventionSelect').value;
            
            if (!metric || !interventionDate) {
                alert('Please select both a metric and an intervention date');
                return;
            }
            
            try {
                const response = await fetch(`/rdd/plot/${encodeURIComponent(metric)}/${encodeURIComponent(interventionDate)}`);
                const result = await response.json();
                
                if (result.error) {
                    document.getElementById('rddResults').innerHTML = `<p style="color: red;">${result.error}</p>`;
                    return;
                }
                
                // Display RDD results text
                displayRDDResults(result.effect_analysis, metric);
                
                // Create RDD plot with before/after slopes
                createRDDPlot(result.plot_data);
                
            } catch (error) {
                console.error('RDD analysis failed:', error);
                document.getElementById('rddResults').innerHTML = '<p style="color: red;">Analysis failed. Please try again.</p>';
            }
        }
        
        function displayRDDResults(result, metric) {
            let html = `<h4>üìä Analysis Results for ${metric.replace('_', ' ').toUpperCase()}</h4>`;
            
            if (result.treatment_effect !== undefined) {
                const effectColor = result.statistically_significant ? '#28a745' : '#6c757d';
                const effectText = result.statistically_significant ? 'Statistically Significant' : 'Not Significant';
                
                html += `
                    <div style="background: white; padding: 15px; border-radius: 8px; border: 2px solid ${effectColor};">
                        <h5 style="color: ${effectColor}; margin-top: 0;">${effectText}</h5>
                        <p><strong>Treatment Effect:</strong> ${result.treatment_effect.toFixed(3)}</p>
                        <p><strong>P-value:</strong> ${result.treatment_p_value.toFixed(4)}</p>
                        <p><strong>Effect Size:</strong> ${Math.abs(result.treatment_effect).toFixed(3)} units</p>
                        <p><strong>Bandwidth:</strong> ${result.bandwidth_days} days</p>
                        <p><strong>Data Points:</strong> ${result.n_observations}</p>
                    </div>
                `;
            } else {
                html += '<p>No effect could be estimated. Try adjusting the bandwidth or check if you have enough data points.</p>';
            }
            
            document.getElementById('rddResults').innerHTML = html;
        }
        
        function createRDDPlot(plotData) {
            if (plotData.error) {
                document.getElementById('rddPlotChart').innerHTML = `<p style="color: red;">${plotData.error}</p>`;
                return;
            }
            
            const traces = [];
            
            // Scatter plot of data points
            if (plotData.scatter) {
                // Before treatment points
                const beforeX = plotData.scatter.x_all.filter((x, i) => plotData.scatter.treatment[i] === 0);
                const beforeY = plotData.scatter.y_all.filter((x, i) => plotData.scatter.treatment[i] === 0);
                
                traces.push({
                    x: beforeX,
                    y: beforeY,
                    mode: 'markers',
                    type: 'scatter',
                    name: 'Before Treatment',
                    marker: { color: 'blue', size: 8, opacity: 0.7 }
                });
                
                // After treatment points  
                const afterX = plotData.scatter.x_all.filter((x, i) => plotData.scatter.treatment[i] === 1);
                const afterY = plotData.scatter.y_all.filter((x, i) => plotData.scatter.treatment[i] === 1);
                
                traces.push({
                    x: afterX,
                    y: afterY,
                    mode: 'markers',
                    type: 'scatter',
                    name: 'After Treatment',
                    marker: { color: 'red', size: 8, opacity: 0.7 }
                });
            }
            
            // Before treatment regression line
            if (plotData.before_line) {
                traces.push({
                    x: plotData.before_line.x,
                    y: plotData.before_line.y,
                    mode: 'lines',
                    type: 'scatter',
                    name: 'Before Trend',
                    line: { color: 'blue', width: 3, dash: 'solid' }
                });
            }
            
            // After treatment regression line
            if (plotData.after_line) {
                traces.push({
                    x: plotData.after_line.x,
                    y: plotData.after_line.y,
                    mode: 'lines',
                    type: 'scatter',
                    name: 'After Trend',
                    line: { color: 'red', width: 3, dash: 'solid' }
                });
            }
            
            // Cutoff line
            traces.push({
                x: [plotData.cutoff, plotData.cutoff],
                y: [Math.min(...plotData.scatter.y_all) * 0.9, Math.max(...plotData.scatter.y_all) * 1.1],
                mode: 'lines',
                type: 'scatter',
                name: 'Treatment Start',
                line: { color: 'black', width: 2, dash: 'dash' }
            });
            
            const layout = {
                title: `Regression Discontinuity Analysis<br><sub>Treatment Effect: ${plotData.treatment_effect.toFixed(3)}</sub>`,
                xaxis: { title: 'Days Relative to Treatment Start' },
                yaxis: { title: 'Metric Value' },
                template: 'plotly_white'
            };
            
            Plotly.newPlot('rddPlotChart', traces, layout);
        }
        
        async function analyzeTimeSeries() {
            const metric = document.getElementById('timeseriesMetricSelect').value;
            
            if (!metric) {
                alert('Please select a metric');
                return;
            }
            
            try {
                const response = await fetch(`/metrics/decompose/${encodeURIComponent(metric)}`);
                const result = await response.json();
                
                if (result.error) {
                    document.getElementById('timeseriesChart').innerHTML = `<p style="color: red;">${result.error}</p>`;
                    return;
                }
                
                // Create time series plot
                createTimeSeriesPlot(result);
                
                // Create decomposition plot if available
                if (result.decomposition && !result.decomposition.error) {
                    createDecompositionPlot(result);
                } else {
                    document.getElementById('decompositionChart').innerHTML = '<p>Decomposition not available - need more data points</p>';
                }
                
            } catch (error) {
                console.error('Time series analysis failed:', error);
                document.getElementById('timeseriesChart').innerHTML = '<p style="color: red;">Analysis failed. Please try again.</p>';
            }
        }
        
        function createTimeSeriesPlot(data) {
            const traces = [];
            
            // Original time series - use bar plot for better weekly data visualization
            traces.push({
                x: data.original.dates,
                y: data.original.values,
                type: 'bar',
                name: 'Original Data',
                marker: { color: 'blue' }
            });
            
            // Forecast if available
            if (data.forecast) {
                traces.push({
                    x: data.forecast.dates,
                    y: data.forecast.predicted,
                    mode: 'lines',
                    type: 'scatter',
                    name: 'Forecast',
                    line: { color: 'red', dash: 'dash' }
                });
                
                // Confidence intervals if available
                if (data.forecast.lower_ci) {
                    traces.push({
                        x: data.forecast.dates.concat(data.forecast.dates.slice().reverse()),
                        y: data.forecast.lower_ci.concat(data.forecast.upper_ci.slice().reverse()),
                        fill: 'toself',
                        fillcolor: 'rgba(255,0,0,0.2)',
                        line: { color: 'transparent' },
                        name: 'Forecast CI',
                        showlegend: false
                    });
                }
            }
            
            const layout = {
                title: `${data.metric} Time Series with Forecast`,
                xaxis: { title: 'Date' },
                yaxis: { title: 'Value' },
                template: 'plotly_white'
            };
            
            Plotly.newPlot('timeseriesChart', traces, layout);
        }
        
        function createDecompositionPlot(data) {
            if (!data.decomposition || data.decomposition.error) return;
            
            const decomp = data.decomposition;
            
            // Create subplots for trend, seasonal, residual
            const traces = [];
            
            // Trend
            traces.push({
                x: decomp.trend.dates,
                y: decomp.trend.values,
                mode: 'lines',
                type: 'scatter',
                name: 'Trend',
                yaxis: 'y1'
            });
            
            // Seasonal
            traces.push({
                x: decomp.seasonal.dates,
                y: decomp.seasonal.values,
                mode: 'lines',
                type: 'scatter',
                name: 'Seasonal',
                yaxis: 'y2'
            });
            
            // Residual
            traces.push({
                x: decomp.residual.dates,
                y: decomp.residual.values,
                mode: 'lines',
                type: 'scatter',
                name: 'Residual',
                yaxis: 'y3'
            });
            
            const layout = {
                title: 'Time Series Decomposition (ARIMA)',
                grid: {rows: 3, columns: 1, subplots:[['xy'],['xy2'],['xy3']]},
                yaxis: {title: 'Trend'},
                yaxis2: {title: 'Seasonal'},
                yaxis3: {title: 'Residual'},
                template: 'plotly_white',
                height: 600
            };
            
            Plotly.newPlot('decompositionChart', traces, layout);
        }
        
        async function generateBiomarkerDeltas() {
            const biomarker = document.getElementById('deltaBiomarkerSelect').value;
            const months = document.getElementById('deltaMonthsSelect').value;
            
            if (!biomarker) {
                alert('Please select a biomarker');
                return;
            }
            
            try {
                const response = await fetch(`/ai/biomarker-delta/${encodeURIComponent(biomarker)}?months_ahead=${months}`);
                const prediction = await response.json();
                
                if (prediction.error) {
                    document.getElementById('deltaPredictions').innerHTML = `<p style="color: red;">${prediction.error}</p>`;
                    return;
                }
                
                // Create prediction card
                createPredictionCard(prediction);
                
            } catch (error) {
                console.error('Biomarker delta prediction failed:', error);
                document.getElementById('deltaPredictions').innerHTML = '<p style="color: red;">Prediction failed. Please try again.</p>';
            }
        }
        
        function createPredictionCard(prediction) {
            const cardClass = prediction.is_improvement ? 'prediction-improvement' : 
                             (Math.abs(prediction.predicted_delta) < 0.1 ? 'prediction-neutral' : 'prediction-decline');
            
            const deltaText = prediction.predicted_delta > 0 ? 
                `+${prediction.predicted_delta}` : 
                `${prediction.predicted_delta}`;
            
            const improvementIcon = prediction.is_improvement ? '‚úÖ' : '‚ö†Ô∏è';
            
            const html = `
                <div class="prediction-card ${cardClass}">
                    <h4>${improvementIcon} ${prediction.biomarker}</h4>
                    <div class="prediction-value">
                        ${prediction.current_value} ‚Üí ${prediction.predicted_value}
                    </div>
                    <div class="prediction-delta">
                        Change: <strong>${deltaText}</strong>
                        ${prediction.is_improvement ? '(Improvement)' : '(Monitor)'}
                    </div>
                    <div style="margin: 10px 0;">
                        <small><strong>Confidence:</strong> ${(prediction.confidence * 100).toFixed(0)}%</small><br>
                        <small><strong>Timeframe:</strong> ${prediction.timeframe}</small><br>
                        <small><strong>Method:</strong> ${prediction.analysis_method}</small>
                    </div>
                    <div class="prediction-reasoning">
                        <strong>Reasoning:</strong> ${prediction.reasoning}
                    </div>
                    <div style="margin-top: 10px;">
                        <small><strong>Recommendation:</strong> ${prediction.recommendation}</small>
                    </div>
                </div>
            `;
            
            document.getElementById('deltaPredictions').innerHTML = html;
        }
        
        // Original functions (modified for new structure)
        async function uploadCSV(input) {
            const file = input.files[0];
            if (!file) return;
            
            const formData = new FormData();
            formData.append('file', file);
            
            try {
                const response = await fetch('/upload-csv', {
                    method: 'POST',
                    body: formData
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    alert(result.message);
                    loadDashboardData(); // Refresh all data
                } else {
                    alert('Upload failed: ' + result.detail);
                }
            } catch (error) {
                alert('Upload failed: ' + error.message);
            }
        }
        
        async function addBiomarker(event) {
            event.preventDefault();
            
            const biomarker = {
                name: document.getElementById('biomarkerName').value,
                value: parseFloat(document.getElementById('biomarkerValue').value),
                unit: document.getElementById('biomarkerUnit').value,
                test_date: document.getElementById('testDate').value
            };
            
            try {
                const response = await fetch('/biomarkers', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(biomarker)
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    alert(result.message);
                    event.target.reset();
                    loadDashboardData(); // Refresh all data
                } else {
                    alert('Failed to add biomarker: ' + result.detail);
                }
            } catch (error) {
                alert('Failed to add biomarker: ' + error.message);
            }
        }
        
        async function addSupplement(event) {
            event.preventDefault();
            
            const supplement = {
                name: document.getElementById('supplementName').value,
                start_date: document.getElementById('supplementStartDate').value,
                dosage: document.getElementById('supplementDosage').value,
                expected_biomarkers: document.getElementById('expectedBiomarkers').value,
                notes: document.getElementById('supplementNotes').value
            };
            
            try {
                const response = await fetch('/supplements', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(supplement)
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    alert(result.message);
                    event.target.reset();
                    loadDashboardData(); // Refresh all data
                } else {
                    alert('Failed to add supplement: ' + result.detail);
                }
            } catch (error) {
                alert('Failed to add supplement: ' + error.message);
            }
        }
    </script>
</body>
</html>